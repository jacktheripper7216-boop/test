<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - Products & Stocks</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .product-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .product-header {
            background: #1976d2;
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-header:hover {
            background: #1565c0;
        }

        .product-title {
            font-size: 18px;
            font-weight: 600;
        }

        .product-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .product-toggle {
            font-size: 20px;
            transition: transform 0.3s;
        }

        .product-toggle.expanded {
            transform: rotate(180deg);
        }

        .product-details {
            padding: 15px 20px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
        }

        .product-details p {
            margin: 5px 0;
            color: #555;
        }

        .product-details strong {
            color: #333;
        }

        .stocks-container {
            padding: 0;
            display: none;
        }

        .stocks-container.visible {
            display: block;
        }

        .stocks-header {
            background: #e3f2fd;
            padding: 10px 20px;
            font-weight: 600;
            color: #1976d2;
            border-bottom: 1px solid #bbdefb;
        }

        .stock-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stock-item:last-child {
            border-bottom: none;
        }

        .stock-item:hover {
            background: #fafafa;
        }

        .stock-field {
            display: flex;
            flex-direction: column;
        }

        .stock-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 3px;
        }

        .stock-value {
            font-size: 14px;
            color: #333;
        }

        .no-stocks {
            padding: 20px;
            text-align: center;
            color: #888;
            font-style: italic;
        }

        .total-quantity {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px 20px;
            font-weight: 600;
        }

        .add-stock-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 20px;
        }

        .add-stock-btn:hover {
            background: #43a047;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.visible {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1976d2;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d5d5d5;
        }

        .summary-bar {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .summary-item {
            padding: 10px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 600;
            color: #1976d2;
        }

        .summary-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Inventory Management</h1>

        <div class="summary-bar" id="summaryBar">
            <div class="summary-item">
                <div class="summary-value" id="totalProducts">-</div>
                <div class="summary-label">Total Products</div>
            </div>
            <div class="summary-item">
                <div class="summary-value" id="totalStocks">-</div>
                <div class="summary-label">Stock Entries</div>
            </div>
            <div class="summary-item">
                <div class="summary-value" id="totalQuantity">-</div>
                <div class="summary-label">Total Quantity</div>
            </div>
        </div>

        <div id="errorContainer"></div>
        <div id="productsContainer">
            <div class="loading">Loading products...</div>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal" id="addStockModal">
        <div class="modal-content">
            <div class="modal-header">Add Stock for <span id="modalProductName"></span></div>
            <form id="addStockForm">
                <input type="hidden" id="stockProductId">
                <div class="form-group">
                    <label for="stockLocation">Location</label>
                    <input type="text" id="stockLocation" required placeholder="Warehouse location">
                </div>
                <div class="form-group">
                    <label for="stockQuantity">Quantity</label>
                    <input type="number" id="stockQuantity" required min="1" placeholder="Enter quantity">
                </div>
                <div class="form-group">
                    <label for="stockCostPrice">Cost Price</label>
                    <input type="number" id="stockCostPrice" step="0.01" min="0" placeholder="Enter cost price">
                </div>
                <div class="form-group">
                    <label for="stockSellingPrice">Selling Price</label>
                    <input type="number" id="stockSellingPrice" step="0.01" min="0" required placeholder="Enter selling price">
                </div>
                <div class="form-group">
                    <label for="stockSupplierId">Supplier ID</label>
                    <input type="number" id="stockSupplierId" min="1" placeholder="Enter supplier ID">
                </div>
                <div class="form-group">
                    <label for="stockExpirationDate">Expiration Date (optional)</label>
                    <input type="date" id="stockExpirationDate">
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Add Stock</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let productsData = [];
        let stocksData = {};

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            document.getElementById('addStockForm').addEventListener('submit', handleAddStock);
        });

        // Load all products
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}/products`);
                if (!response.ok) throw new Error('Failed to load products');

                productsData = await response.json();

                // Load stocks for all products
                await loadAllStocks();

                renderProducts();
                updateSummary();
            } catch (error) {
                showError('Error loading products: ' + error.message);
            }
        }

        // Load stocks for all products
        async function loadAllStocks() {
            const promises = productsData.map(async (product) => {
                try {
                    const response = await fetch(`${API_BASE}/products/${product.id}/stocks`);
                    if (response.ok) {
                        stocksData[product.id] = await response.json();
                    } else {
                        stocksData[product.id] = [];
                    }
                } catch (error) {
                    stocksData[product.id] = [];
                }
            });

            await Promise.all(promises);
        }

        // Render products with their stocks
        function renderProducts() {
            const container = document.getElementById('productsContainer');

            if (productsData.length === 0) {
                container.innerHTML = '<div class="no-stocks">No products found</div>';
                return;
            }

            container.innerHTML = productsData.map(product => {
                const stocks = stocksData[product.id] || [];
                const totalQty = stocks.reduce((sum, s) => sum + (s.quantity || 0), 0);

                return `
                    <div class="product-card">
                        <div class="product-header" onclick="toggleStocks(${product.id})">
                            <div>
                                <div class="product-title">${escapeHtml(product.name)}</div>
                                <div class="product-info">
                                    ${product.brand ? product.brand + ' | ' : ''}
                                    ${product.categoryName || 'No Category'} |
                                    ${stocks.length} stock entries |
                                    Total: ${totalQty} units
                                </div>
                            </div>
                            <span class="product-toggle" id="toggle-${product.id}">&#9660;</span>
                        </div>
                        <div class="product-details">
                            <p><strong>ID:</strong> ${product.id}</p>
                            ${product.description ? `<p><strong>Description:</strong> ${escapeHtml(product.description)}</p>` : ''}
                            ${product.warrantyMonths ? `<p><strong>Warranty:</strong> ${product.warrantyMonths} months</p>` : ''}
                        </div>
                        <div class="stocks-container" id="stocks-${product.id}">
                            <div class="stocks-header">Stock Inventory</div>
                            ${stocks.length > 0 ? `
                                <div class="total-quantity">Total Quantity: ${totalQty} units</div>
                                ${stocks.map(stock => `
                                    <div class="stock-item">
                                        <div class="stock-field">
                                            <span class="stock-label">Stock ID</span>
                                            <span class="stock-value">${stock.id}</span>
                                        </div>
                                        <div class="stock-field">
                                            <span class="stock-label">Location</span>
                                            <span class="stock-value">${escapeHtml(stock.location || 'N/A')}</span>
                                        </div>
                                        <div class="stock-field">
                                            <span class="stock-label">Quantity</span>
                                            <span class="stock-value">${stock.quantity || 0}</span>
                                        </div>
                                        <div class="stock-field">
                                            <span class="stock-label">Cost Price</span>
                                            <span class="stock-value">$${stock.costPrice || '0.00'}</span>
                                        </div>
                                        <div class="stock-field">
                                            <span class="stock-label">Selling Price</span>
                                            <span class="stock-value">$${stock.sellingPrice || '0.00'}</span>
                                        </div>
                                        <div class="stock-field">
                                            <span class="stock-label">Supplier</span>
                                            <span class="stock-value">${escapeHtml(stock.supplierName || 'N/A')}</span>
                                        </div>
                                        ${stock.expirationDate ? `
                                            <div class="stock-field">
                                                <span class="stock-label">Expires</span>
                                                <span class="stock-value">${stock.expirationDate}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            ` : '<div class="no-stocks">No stocks available for this product</div>'}
                            <button class="add-stock-btn" onclick="openAddStockModal(${product.id}, '${escapeHtml(product.name)}')">
                                + Add Stock
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle stocks visibility
        function toggleStocks(productId) {
            const stocksContainer = document.getElementById(`stocks-${productId}`);
            const toggleIcon = document.getElementById(`toggle-${productId}`);

            stocksContainer.classList.toggle('visible');
            toggleIcon.classList.toggle('expanded');
        }

        // Update summary bar
        function updateSummary() {
            const totalProducts = productsData.length;
            let totalStocks = 0;
            let totalQuantity = 0;

            Object.values(stocksData).forEach(stocks => {
                totalStocks += stocks.length;
                stocks.forEach(stock => {
                    totalQuantity += stock.quantity || 0;
                });
            });

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalStocks').textContent = totalStocks;
            document.getElementById('totalQuantity').textContent = totalQuantity;
        }

        // Open add stock modal
        function openAddStockModal(productId, productName) {
            document.getElementById('stockProductId').value = productId;
            document.getElementById('modalProductName').textContent = productName;
            document.getElementById('addStockModal').classList.add('visible');
        }

        // Close modal
        function closeModal() {
            document.getElementById('addStockModal').classList.remove('visible');
            document.getElementById('addStockForm').reset();
        }

        // Handle add stock form submission
        async function handleAddStock(e) {
            e.preventDefault();

            const productId = document.getElementById('stockProductId').value;
            const stockData = {
                product_id: parseInt(productId),
                location: document.getElementById('stockLocation').value,
                quantity: parseInt(document.getElementById('stockQuantity').value),
                selling_price: parseFloat(document.getElementById('stockSellingPrice').value)
            };

            const costPrice = document.getElementById('stockCostPrice').value;
            if (costPrice) stockData.cost_price = parseFloat(costPrice);

            const supplierId = document.getElementById('stockSupplierId').value;
            if (supplierId) stockData.supplier_id = parseInt(supplierId);

            const expirationDate = document.getElementById('stockExpirationDate').value;
            if (expirationDate) stockData.expiration_date = expirationDate;

            try {
                const response = await fetch(`${API_BASE}/stocks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(stockData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to add stock');
                }

                closeModal();
                await loadProducts();
            } catch (error) {
                showError('Error adding stock: ' + error.message);
            }
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
